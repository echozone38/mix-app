<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingredience & porce</title>
  manifest.json
  <meta name="theme-color" content="#0bbf55" />
  <style>
    :root { --accent:#0bbf55; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1 { font-size:1.2rem; margin:0; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 800px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; background:#fff; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input[type="number"], input[type="text"], select { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .muted { color:#555; font-size:0.9rem; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex:1; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .btn-primary { background:var(--accent); color:#fff; border:none; }
    .btn-danger { background:#d33; color:#fff; border:none; }
    .btn-small { padding:6px 10px; font-size:0.9rem; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    th { background:#f7f7f7; position:sticky; top:0; z-index:1; }
    tfoot td { font-weight:700; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; color:#224; font-size:0.8rem; }
    .note { background:#f8fff8; border:1px solid #cfe; padding:8px; border-radius:8px; }
  </style>
</head>
<body>
<header>
  <h1>Ingredience & porce</h1>
  <div class="row" style="justify-content:flex-end; flex:0 0 auto;">
    <button id="resetAll" class="btn">Vymazat data</button>
    <button id="installBtn" class="btn">Přidat na plochu</button>
  </div>
</header>

<div class="card note">
  <strong>Režimy:</strong>
  <span class="badge">Recept</span> → zadáte <em>počet osob</em>, aplikace spočítá <em>celkovou směs</em>. &nbsp;|&nbsp;
  <span class="badge">Směs</span> → zadáte <em>celkovou směs [g]</em>, aplikace dopočítá <em>počet osob</em>.
</div>

<div class="grid">
  <!-- Režim + základní parametry -->
  <div class="card">
    <label>Režim</label>
    <div class="row">
      <select id="mode">
        <option value="recept">Recept (počítat celkovou směs z počtu osob)</option>
        <option value="smes">Směs (počítat počet osob z celkové směsi)</option>
      </select>
    </div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label for="portionG">Porce na osobu [g]</label>
        <input id="portionG" type="number" step="1" min="0" placeholder="např. 250" />
      </div>
      <div>
        <label for="persons">Počet osob</label>
        <input id="persons" type="number" step="1" min="0" placeholder="např. 10" />
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label for="totalMixG">Celková hmotnost hotové směsi [g]</label>
        <input id="totalMixG" type="number" step="1" min="0" placeholder="např. 2500" />
      </div>
      <div>
        <label for="totalMixKJ">Nutriční hodnota směsi [kJ]</label>
        <input id="totalMixKJ" type="text" value="—" disabled />
      </div>
    </div>

    <p class="muted" id="ratioInfo">Podíl porce/směsi: —</p>
  </div>

  <!-- Přidání ingredience -->
  <div class="card">
    <label>Nová ingredience</label>
    <div class="row">
      <input id="newName" type="text" placeholder="např. Ovesné vločky" />
      <select id="newUnit">
        <option value="g">g</option>
        <option value="ml">ml</option>
      </select>
      <input id="newPerPortion" type="number" step="0.1" min="0" placeholder="Množství v 1 porci" />
    </div>
    <div class="row" style="margin-top:6px;">
      <input id="newDensity" type="number" step="0.001" min="0" placeholder="Hustota [g/ml] (jen pro ml)" />
      <input id="newKJ100" type="number" step="1" min="0" placeholder="kJ / 100 g" />
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="newOptimizable" type="checkbox" />
        Optimalizovatelná
      </label>
    </div>
    <div style="margin-top:8px;">
      <button id="addRow" class="btn-primary btn">Přidat ingredienci</button>
    </div>
  </div>
</div>

<!-- Tabulka ingrediencí -->
<div class="card" style="margin-top:16px;">
  <table id="ingTable">
    <thead>
      <tr>
        <th>Ingredience</th>
        <th>Jednotka</th>
        <th>Množství v 1 porci</th>
        <th>Hustota [g/ml]</th>
        <th>Gramy v 1 porci [g]</th>
        <th>kJ / 100 g</th>
        <th>Energie v 1 porci [kJ]</th>
        <th>Optimalizovat</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="4">Součet gramů v 1 porci [g]</td>
        <td id="sumPortionG">0</td>
        <td colspan="2">Součet energie v 1 porci [kJ]</td>
        <td id="sumPortionKJ">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Optimalizace -->
<div class="card">
  <div class="row">
    <div>
      <label for="maxKJ">Max. kJ na porci (optimalizace)</label>
      <input id="maxKJ" type="number" step="1" min="0" placeholder="např. 1700" />
    </div>
    <div style="display:flex; align-items:flex-end;">
      <button id="optimizeBtn" class="btn">Optimalizovat</button>
    </div>
  </div>
  <p class="muted">
    Pozn.: Optimalizace zjednodušeně **škáluje** poměr pouze u ingrediencí označených jako „Optimalizovatelná“, aby součet energie na porci spadl pod zadaný limit.
    Gramáž porce se po optimalizaci **přizpůsobí** výsledku (lze změnit na „držet konstantní porci“ později).
  </p>
</div>

<!-- Historie receptů -->
<div class="card">
  <label>Historie receptů (lokálně, offline)</label>
  <div class="row">
    <input id="recipeName" type="text" placeholder="Název receptu (např. Vločková směs 10×250g)" />
    <button id="saveRecipe" class="btn-primary btn">Uložit</button>
  </div>
  <div style="margin-top:8px;">
    <ul id="recipeList"></ul>
  </div>
</div>

<script>
  // ---------- Stav & uložení ----------
  const LS_KEY = 'mix-app-v2-state';
  let deferredPrompt = null;

  const state = {
    mode: 'recept',          // 'recept' | 'smes'
    portionG: 0,             // porce na osobu [g]
    persons: 0,              // počet osob
    totalMixG: 0,            // celková směs [g]
    maxKJ: 0,                // optimalizační limit [kJ/porci]
    ingredients: []          // {name, unit:'g'|'ml', perPortion:number, density?:number, kj100:number, optimizable:boolean}
  };

  function saveState() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    refreshRecipeList(); // aby se v seznamu ukázalo, když je název stejný
  }
  function loadState() {
    const s = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
    Object.assign(state, s);
  }

  // ---------- Pomocné funkce ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = (n, d=2) => (isNaN(n) || n === null) ? '—' : Number(n).toFixed(d);

  function gramsInPortion(ing) {
    if (ing.unit === 'g') return ing.perPortion || 0;
    const d = Number(ing.density || 0);
    const ml = Number(ing.perPortion || 0);
    return d > 0 ? ml * d : 0;
  }
  function energyInPortionKJ(ing) {
    const g = gramsInPortion(ing);
    const kj100 = Number(ing.kj100 || 0);
    return g * kj100 / 100;
  }

  function recompute() {
    // Režimy: přepočet směsi ⇄ osoby
    const portionG = Number($('#portionG').value || 0);
    const persons = Number($('#persons').value || 0);
    const totalMixGInput = Number($('#totalMixG').value || 0);

    state.portionG = portionG;
    state.persons = persons;

    // Součty v porci
    let sumG = 0, sumKJ = 0;
    state.ingredients.forEach(ing => {
      const g = gramsInPortion(ing);
      sumG += g;
      sumKJ += energyInPortionKJ(ing);
    });
    $('#sumPortionG').textContent = fmt(sumG, 2);
    $('#sumPortionKJ').textContent = fmt(sumKJ, 0);

    // Režim Recept: známe persons + portionG → totalMixG
    // Režim Směs: známe totalMixG + portionG → persons
    if ($('#mode').value === 'recept') {
      const totalMixG = portionG * persons;
      state.totalMixG = totalMixG;
      $('#totalMixG').value = isFinite(totalMixG) ? totalMixG : '';
    } else {
      const totalMixG = totalMixGInput;
      state.totalMixG = totalMixG;
      const computedPersons = portionG > 0 ? (totalMixG / portionG) : 0;
      $('#persons').value = isFinite(computedPersons) ? Math.floor(computedPersons) : '';
    }

    // Poměr porce/směsi
    const ratioPct = (state.portionG > 0 && state.totalMixG > 0)
      ? (state.portionG / state.totalMixG) * 100
      : NaN;
    $('#ratioInfo').textContent = isNaN(ratioPct)
      ? 'Podíl porce/směsi: —'
      : `Podíl porce/směsi: ${fmt(ratioPct)} %`;

    // Nutriční hodnota směsi (sum mix kJ) = persons * sumKJ (protože mix = součet porcí)
    const totalMixKJ = persons * sumKJ;
    $('#totalMixKJ').value = fmt(totalMixKJ, 0);

    // Překreslit tabulku (gramy & energie v 1 porci)
    renderTableRows();
    saveState();
  }

  // ---------- Tabulka ingrediencí ----------
  function addRowFromForm() {
    const ing = {
      name: $('#newName').value.trim(),
      unit: $('#newUnit').value,
      perPortion: Number($('#newPerPortion').value || 0),
      density: Number($('#newDensity').value || 0),
      kj100: Number($('#newKJ100').value || 0),
      optimizable: $('#newOptimizable').checked
    };
    state.ingredients.push(ing);
    $('#newName').value = ''; $('#newPerPortion').value = '';
    $('#newDensity').value = ''; $('#newKJ100').value = ''; $('#newOptimizable').checked = false;
    renderTableRows();
    recompute();
  }

  function renderTableRows() {
    const tbody = $('#ingTable tbody');
    tbody.innerHTML = '';
    state.ingredients.forEach((ing, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="cell-name" type="text" value="${ing.name}" /></td>
        <td>
          <select class="cell-unit">
            <option value="g" ${ing.unit==='g'?'selected':''}>g</option>
            <option value="ml" ${ing.unit==='ml'?'selected':''}>ml</option>
          </select>
        </td>
        <td><input class="cell-per" type="number" step="0.1" min="0" value="${ing.perPortion || 0}" /></td>
        <td><input class="cell-density" type="number" step="0.001" min="0" value="${ing.density || ''}" ${ing.unit==='ml'?'':'disabled'} /></td>
        <td class="cell-grams">${fmt(gramsInPortion(ing), 2)}</td>
        <td><input class="cell-kj100" type="number" step="1" min="0" value="${ing.kj100 || 0}" /></td>
        <td class="cell-kj">${fmt(energyInPortionKJ(ing), 0)}</td>
        <td style="text-align:center;"><input class="cell-opt" type="checkbox" ${ing.optimizable?'checked':''} /></td>
        <td>
          <button class="btn btn-small up">↑</button>
          <button class="btn btn-small down">↓</button>
          <button class="btn btn-small btn-danger remove">Smazat</button>
        </td>
      `;
      // Handlery
      const nameInput = tr.querySelector('.cell-name');
      const unitSel = tr.querySelector('.cell-unit');
      const perInput = tr.querySelector('.cell-per');
      const densInput = tr.querySelector('.cell-density');
      const kj100Input = tr.querySelector('.cell-kj100');
      const optChk = tr.querySelector('.cell-opt');

      nameInput.addEventListener('input', e => { ing.name = e.target.value; saveState(); });
      unitSel.addEventListener('change', e => { ing.unit = e.target.value; densInput.disabled = ing.unit !== 'ml'; recompute(); });
      perInput.addEventListener('input', e => { ing.perPortion = Number(e.target.value || 0); recompute(); });
      densInput.addEventListener('input', e => { ing.density = Number(e.target.value || 0); recompute(); });
      kj100Input.addEventListener('input', e => { ing.kj100 = Number(e.target.value || 0); recompute(); });
      optChk.addEventListener('change', e => { ing.optimizable = e.target.checked; saveState(); });

      tr.querySelector('.remove').addEventListener('click', () => { state.ingredients.splice(idx,1); renderTableRows(); recompute(); });
      tr.querySelector('.up').addEventListener('click', () => {
        if (idx > 0) [state.ingredients[idx-1], state.ingredients[idx]] = [state.ingredients[idx], state.ingredients[idx-1]];
        renderTableRows(); recompute();
      });
      tr.querySelector('.down').addEventListener('click', () => {
        if (idx < state.ingredients.length-1) [state.ingredients[idx+1], state.ingredients[idx]] = [state.ingredients[idx], state.ingredients[idx+1]];
        renderTableRows(); recompute();
      });

      tbody.appendChild(tr);
    });
  }

  // ---------- Optimalizace ----------
  function optimize() {
    const limit = Number($('#maxKJ').value || 0);
    state.maxKJ = limit;
    // Současná energie na porci
    const E_total = state.ingredients.reduce((s, ing) => s + energyInPortionKJ(ing), 0);
    if (!isFinite(limit) || limit <= 0) { alert('Zadejte platný limit kJ na porci.'); return; }
    if (E_total <= limit) { alert('Energie na porci je již pod limitem.'); return; }

    // Rozdělit na optimalizovatelné vs. fixní
    let E_opt = 0, E_fix = 0;
    // Získáme i aktuální gramy/ml v porci pro optimizovatelné
    const optSet = [];
    state.ingredients.forEach(ing => {
      const e = energyInPortionKJ(ing);
      if (ing.optimizable) { E_opt += e; optSet.push(ing); }
      else { E_fix += e; }
    });
    if (E_opt <= 0) { alert('Žádná ingredience není označena jako optimalizovatelná.'); return; }

    // Měřítko s tak, aby E_fix + s * E_opt = limit → s = (limit - E_fix)/E_opt
    let s = (limit - E_fix) / E_opt;
    if (!isFinite(s) || s < 0) s = 0;
    if (s > 1) s = 1; // kdyby limit byl vyšší než současná energie optimalizovatelných

    // Škálování „Množství v 1 porci“ u optimalizovatelných ingrediencí
    optSet.forEach(ing => {
      const g = gramsInPortion(ing);
      const gNew = g * s;
      if (ing.unit === 'g') {
        ing.perPortion = gNew;
      } else {
        const d = Number(ing.density || 0);
        ing.perPortion = d > 0 ? (gNew / d) : 0; // zpět na ml
      }
    });

    // Po škálování se změní součet gramů v porci → upravíme porci tak, aby odpovídala novému součtu
    const newSumG = state.ingredients.reduce((s, ing) => s + gramsInPortion(ing), 0);
    state.portionG = newSumG;
    $('#portionG').value = fmt(newSumG, 0);

    // Přepočet mixu/osob dle režimu
    if ($('#mode').value === 'recept') {
      // držíme počet osob → mix se změní
      state.totalMixG = state.persons * state.portionG;
      $('#totalMixG').value = fmt(state.totalMixG, 0);
    } else {
      // držíme celkovou směs → počet osob se změní
      const persons = state.portionG > 0 ? (state.totalMixG / state.portionG) : 0;
      state.persons = Math.floor(persons);
      $('#persons').value = fmt(state.persons, 0);
    }

    recompute();
    alert('Optimalizace hotová. Porce a poměry upraveny tak, aby energie na porci splnila limit.');
  }

  // ---------- Historie receptů ----------
  const LS_RECIPES = 'mix-app-v2-recipes';
  function getRecipes() { return JSON.parse(localStorage.getItem(LS_RECIPES) || '[]'); }
  function setRecipes(arr) { localStorage.setItem(LS_RECIPES, JSON.stringify(arr)); }
  function saveRecipe() {
    const name = $('#recipeName').value.trim();
    if (!name) { alert('Zadejte název receptu.'); return; }
    const recipes = getRecipes();
    const snapshot = JSON.parse(JSON.stringify(state));
    recipes.push({ name, snapshot, savedAt: new Date().toISOString() });
    setRecipes(recipes);
    refreshRecipeList();
    alert('Recept uložen (lokálně).');
  }
  function refreshRecipeList() {
    const list = $('#recipeList');
    list.innerHTML = '';
    getRecipes().forEach((rec, idx) => {
      const li = document.createElement('li');
      const date = new Date(rec.savedAt);
      li.innerHTML = `
        <div class="row" style="gap:6px;">
          <div style="flex:2;">
            <strong>${rec.name}</strong><br/>
            <span class="muted">Uloženo: ${date.toLocaleString()}</span>
          </div>
          <div style="flex:1; display:flex; gap:6px; justify-content:flex-end;">
            <button class="btn btn-small load">Načíst</button>
            <button class="btn btn-small btn-danger del">Smazat</button>
          </div>
        </div>
      `;
      li.querySelector('.load').addEventListener('click', () => {
        Object.assign(state, JSON.parse(JSON.stringify(rec.snapshot)));
        // dosadit vstupy do UI
        $('#mode').value = state.mode;
        $('#portionG').value = state.portionG || '';
        $('#persons').value = state.persons || '';
        $('#totalMixG').value = state.totalMixG || '';
        $('#maxKJ').value = state.maxKJ || '';
        renderTableRows();
        recompute();
      });
      li.querySelector('.del').addEventListener('click', () => {
        const recipes = getRecipes();
        recipes.splice(idx,1);
        setRecipes(recipes);
        refreshRecipeList();
      });
      list.appendChild(li);
    });
  }

  // ---------- PWA instalace ----------
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $('#installBtn').disabled = false;
  });
  $('#installBtn').addEventListener('click', async () => {
    if (!deferredPrompt) { alert('Aplikaci přidejte na plochu přes nabídku prohlížeče.'); return; }
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    $('#installBtn').disabled = true;
  });

  // ---------- Napojení UI ----------
  document.addEventListener('DOMContentLoaded', () => {
    // načíst stav
    loadState();

    // dosadit do UI
    $('#mode').value = state.mode;
    $('#portionG').value = state.portionG || '';
    $('#persons').value = state.persons || '';
    $('#totalMixG').value = state.totalMixG || '';
    $('#maxKJ').value = state.maxKJ || '';

    renderTableRows();
    recompute();
  });

  // Vstupy – handlery
  $('#mode').addEventListener('change', e => { state.mode = e.target.value; saveState(); recompute(); });
  $('#portionG').addEventListener('input', recompute);
  $('#persons').addEventListener('input', recompute);
  $('#totalMixG').addEventListener('input', recompute);
  $('#addRow').addEventListener('click', addRowFromForm);
  $('#optimizeBtn').addEventListener('click', optimize);
  $('#saveRecipe').addEventListener('click', saveRecipe);
  $('#resetAll').addEventListener('click', () => {
    if (confirm('Opravdu vymazat všechna uložená data?')) {
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_RECIPES);
      location.reload();
    }
  });

  // Service worker registrace
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }
</script>
</body>
</html>